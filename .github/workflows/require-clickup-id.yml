name: Require ClickUp ID in PR

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Collect PR data (title/body/branch)
        id: collect
        run: |
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # strip HTML comments from body so placeholders don't count
          BODY_STRIPPED="$(printf "%s" "${{ github.event.pull_request.body }}" | sed -E 's/<!--([^-]|-+[^>])*-->//g')"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY_STRIPPED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT

      - name: Fetch commit messages
        id: commits
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get commit messages via GitHub API
          URL="https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits"
          MSGS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "$URL" | jq -r '.[].commit.message' | tr '\n' ' ')
          echo "messages<<EOF" >> $GITHUB_OUTPUT
          echo "$MSGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate ClickUp ID across title/body/branch/commits
        env:
          TITLE: ${{ steps.collect.outputs.title }}
          BODY:  ${{ steps.collect.outputs.body }}
          HEAD:  ${{ steps.collect.outputs.head_ref }}
          MSGS:  ${{ steps.commits.outputs.messages }}
          # Accept CU-<alnum> or #<alnum-or-dash>. Use -i for case-insensitive.
          REGEX: '(CU-[A-Za-z0-9]+|#[A-Za-z0-9-]+)'
        run: |
          set -e
          echo "PR title: $TITLE"
          echo "PR body : ${BODY:0:200}"
          echo "Branch  : $HEAD"
          echo "Sample commits: ${MSGS:0:200}"

          TEXT="$TITLE
          $BODY
          $HEAD
          $MSGS"

          if printf "%s" "$TEXT" | grep -Eiq "$REGEX"; then
            echo "✅ Found a valid ClickUp ID."
          else
            echo "::error::❌ PR must reference a ClickUp Task ID in the title, body, branch name, or commit message (e.g., CU-86ab8ydtm or #1abc2de)."
            exit 1
          fi
